name: Release

on:
  release:
    types: ['created', 'edited']

jobs:
  build:
    name: Release Asset
    runs-on: ubuntu-latest

    steps:
      - name: 'Prepare the build context'
        uses: actions/checkout@v1

      - name: 'Install system requirements'
        run: |
          sudo apt update
          sudo apt install -y libicu-dev
          sudo apt-fast install -y --no-install-recommends \
            php7.4 php7.4-intl php7.4-mbstring php7.4-pcov php7.4-sqlite php7.4-xml

      - name: 'Install Composer dependencies'
        run: composer install --ignore-platform-reqs --no-progress --optimize-autoloader --classmap-authoritative

      - name: 'Package the application'
        run: |
          composer dump-env prod
          docker run --interactive --volume=$(pwd):/app ajardin/humbug-box compile
          docker run --interactive --volume=$(pwd):/app ajardin/humbug-box info ./build/origami.phar

      - name: 'Upload Release Asset'
        id: upload-release-asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./build/origami.phar
          asset_name: origami.phar
          asset_content_type: application/octet-stream
